<!--
  ~ Copyright 2006-2013 The Kuali Foundation
  ~
  ~ Licensed under the Educational Community License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.opensource.org/licenses/ecl2.php
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:util="http://www.springframework.org/schema/util"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans-3.2.xsd
                           http://www.springframework.org/schema/util
                           http://www.springframework.org/schema/util/spring-util-3.2.xsd
                           http://www.springframework.org/schema/context
                           http://www.springframework.org/schema/context/spring-context-3.2.xsd">

  <bean id="providerRegistry"
        class="org.kuali.rice.core.framework.resourceloader.GlobalResourceLoaderServiceFactoryBean"
        p:serviceName="kd-providerRegistry"/>

  <bean id="dataObjectService"
        class="org.kuali.rice.core.framework.resourceloader.GlobalResourceLoaderServiceFactoryBean"
        p:serviceName="kd-dataObjectService"/>

  <!-- JPA Configuration -->

  <!-- Enables Load-Time Weaving -->
  <context:load-time-weaver/>

  <util:list id="moduleJpaPackagesToScan">
    <!-- add packages here -->
    <value>org.kuali.rice.kim.impl.common.attribute</value>
    <value>org.kuali.rice.kim.impl.membership</value>
    <value>org.kuali.rice.kim.impl.common.active</value>
    <value>org.kuali.rice.kim.impl.group</value>
  </util:list>
  
  <!-- JHK: Should be defined centrally -->
  <bean id="jpaPackagesToScan" 
  		class="org.kuali.rice.core.framework.util.spring.ListMergeBeanFactory">
  		<constructor-arg>
  			<list>
  				<ref bean="coreJpaPackagesToScan"/>
  				<ref bean="kradJpaPackagesToScan"/>
  				<ref bean="moduleJpaPackagesToScan"/>
  			</list>
  		</constructor-arg>
  </bean> 

  <bean id="kimEntityManagerFactory"
        class="org.kuali.rice.krad.data.provider.jpa.eclipselink.KradEclipseLinkEntityManagerFactoryBean"
        p:jtaDataSource-ref="kimDataSource"
        p:persistenceUnitName="kim"
        p:packagesToScan-ref="jpaPackagesToScan"/>

  <bean id="kimSharedEntityManager"
        class="org.springframework.orm.jpa.support.SharedEntityManagerBean"
        p:entityManagerFactory-ref="kimEntityManagerFactory"/>

  <!-- Persistence Provider -->

  <bean id="kimJpaPersistenceProvider"
        class="org.kuali.rice.krad.data.provider.jpa.JpaPersistenceProvider"
        p:providerRegistry-ref="providerRegistry"
        p:dataObjectService-ref="dataObjectService"
        p:sharedEntityManager-ref="kimSharedEntityManager"/>

  <!-- Metadata Providers -->

  <bean id="kimSpringMetadataFileLocations-parentBean"
        class="org.springframework.beans.factory.config.ListFactoryBean"
        p:sourceList="classpath:org/kuali/rice/krad/data/provider/spring/krad-metadata-parent-beans.xml"/>

  <bean id="kimSpringMetadataFileLocations" parent="kimSpringMetadataFileLocations-parentBean"/>

  <bean id="kimMetadataProviderSpring"
        class="org.kuali.rice.krad.data.provider.spring.SpringMetadataProviderImpl"
        p:resourceLocations-ref="kimSpringMetadataFileLocations" />

  <bean id="kimMetadataProviderJpa"
        class="org.kuali.rice.krad.data.provider.jpa.eclipselink.EclipseLinkJpaMetadataProviderImpl"
        p:entityManager-ref="kimSharedEntityManager" />

  <bean id="kimMetadataProviderAnnotation"
        class="org.kuali.rice.krad.data.provider.annotation.impl.AnnotationMetadataProviderImpl"
        p:jpaMetadataProvider-ref="kimMetadataProviderJpa" />

  <bean id="kimMetadataProvider"
        class="org.kuali.rice.krad.data.provider.impl.CompositeMetadataProviderImpl">
    <property name="providers">
      <list>
        <ref bean="kimMetadataProviderJpa" />
        <ref bean="kimMetadataProviderAnnotation" />
        <ref bean="kimMetadataProviderSpring" />
      </list>
    </property>
  </bean>

</beans>